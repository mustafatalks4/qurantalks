<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuranTalks | Read, Listen & Explore the Holy Quran in Urdu</title>
    <meta name="description" content="QuranTalks is a free, beautiful web app for reading and listening to the Holy Quran with Urdu translations, multiple reciters, and bookmarking features.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Amiri:wght@400;700&family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-amiri {
            font-family: 'Amiri', serif;
        }
        .font-urdu {
            font-family: 'Noto Nastaliq Urdu', serif;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #111827; /* bg-gray-900 */
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid #5eead4; /* emerald-300 */
            border-right-color: #10b981; /* emerald-500 */
            animation: l2 1s infinite linear;
        }
        @keyframes l2 {to{transform: rotate(1turn)}}

        @keyframes float-anim {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
            100% { transform: translateY(0px); }
        }
        .ayah-view {
            animation: float-anim 8s ease-in-out infinite;
        }

        .ayah-view.active {
            background-color: var(--tw-bg-opacity, 1) theme('colors.emerald.50');
            border-left-color: theme('colors.emerald.500');
            transform: scale(1.01);
            animation: none; /* Disable float animation when active */
        }
        .dark .ayah-view.active {
            background-color: theme('colors.gray.700');
            border-left-color: theme('colors.emerald.400');
        }
        .rtl { direction: rtl; }
        .ayah-word {
            cursor: pointer;
            display: inline-block;
            transition: background-color 0.2s;
            padding: 0 2px;
            border-radius: 4px;
        }
        .ayah-word:hover {
            background-color: rgba(4, 120, 87, 0.1); /* emerald-500 with 10% opacity */
        }
        .dark .ayah-word:hover {
             background-color: rgba(16, 185, 129, 0.2); /* emerald-400 with 20% opacity */
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        amiri: ['Amiri', 'serif'],
                        urdu: ['Noto Nastaliq Urdu', 'serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen transition-colors duration-300">

    <div id="loading-overlay">
        <div class="loader"></div>
    </div>

    <div id="app" class="opacity-0 transition-opacity duration-500">
        <header class="bg-white/70 dark:bg-gray-900/70 backdrop-blur-lg sticky top-0 z-40 shadow-sm dark:shadow-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-2 cursor-pointer" data-nav="home">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-emerald-500"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">QuranTalks</h1>
                    </div>
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <nav class="hidden md:flex items-center space-x-1">
                            <button data-nav="home" class="nav-item px-3 py-2 text-sm font-medium rounded-md transition-colors">Home</button>
                            <button data-nav="paras" class="nav-item px-3 py-2 text-sm font-medium rounded-md transition-colors">Paras</button>
                            <button data-nav="bookmarks" class="nav-item px-3 py-2 text-sm font-medium rounded-md transition-colors">Bookmarks</button>
                            <button data-nav="about" class="nav-item px-3 py-2 text-sm font-medium rounded-md transition-colors">About</button>
                        </nav>
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg id="theme-icon-dark" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            <svg id="theme-icon-light" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        </button>
                    </div>
                </div>
                <nav class="md:hidden flex items-center justify-around pb-2 border-t border-gray-200 dark:border-gray-700 text-xs no-scrollbar overflow-x-auto">
                    <button data-nav="home" class="nav-item px-2 py-2 font-medium rounded-md transition-colors flex-shrink-0">Home</button>
                    <button data-nav="paras" class="nav-item px-2 py-2 font-medium rounded-md transition-colors flex-shrink-0">Paras</button>
                    <button data-nav="bookmarks" class="nav-item px-2 py-2 font-medium rounded-md transition-colors flex-shrink-0">Bookmarks</button>
                    <button data-nav="about" class="nav-item px-2 py-2 font-medium rounded-md transition-colors flex-shrink-0">About</button>
                </nav>
            </div>
        </header>

        <main class="p-4 md:p-6 lg:p-8 max-w-7xl mx-auto">
            <div id="view-home" class="view space-y-8">
                 <div class="text-center p-8 bg-gradient-to-br from-emerald-50 to-teal-100 dark:from-emerald-900/50 dark:to-teal-900/50 rounded-xl shadow-lg">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white">Welcome to QuranTalks</h2>
                    <p class="mt-2 text-lg text-gray-500 dark:text-gray-400">Discover, Read, and Listen to the Holy Quran.</p>
                </div>
                <div id="daily-ayah-container"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div data-nav="home" class="quick-access-card bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md hover:shadow-xl cursor-pointer transition-all">
                        <h3 class="font-bold text-lg text-emerald-600 dark:text-emerald-400">All Surahs</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Browse all 114 chapters.</p>
                    </div>
                     <div data-nav="paras" class="quick-access-card bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md hover:shadow-xl cursor-pointer transition-all">
                        <h3 class="font-bold text-lg text-emerald-600 dark:text-emerald-400">All Paras</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Read the Quran Juz by Juz.</p>
                    </div>
                </div>
                <div class="sticky top-16 z-30 bg-gray-100 dark:bg-gray-900 py-4">
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input id="search-input" type="text" placeholder="Search for a Surah (e.g., Al-Fatiha, 1...)" class="w-full pl-12 pr-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-full focus:ring-2 focus:ring-emerald-500 focus:outline-none transition">
                    </div>
                </div>
                <div id="surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="view-surah" class="view hidden"></div>
            <div id="view-para-reader" class="view hidden"></div>
            
            <div id="view-paras" class="view hidden"></div>
            <div id="view-bookmarks" class="view hidden"></div>
            <div id="view-about" class="view hidden"></div>
            
            <div id="loading-spinner" class="hidden justify-center items-center py-20"><div class="animate-spin rounded-full h-16 w-16 border-b-2 border-emerald-500"></div></div>
            <div id="error-display" class="hidden"></div>
        </main>

        <div id="floating-player" class="hidden fixed bottom-4 right-4 w-[calc(100%-2rem)] max-w-md bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-lg shadow-2xl p-4 z-50 border border-gray-200 dark:border-gray-700">
            <div class="flex items-center space-x-4">
                <button id="player-play-pause" class="flex-shrink-0 w-12 h-12 bg-emerald-500 text-white rounded-full flex items-center justify-center hover:bg-emerald-600 transition-colors"></button>
                <div class="flex-grow overflow-hidden">
                    <p id="player-surah-name" class="font-bold text-sm truncate text-gray-800 dark:text-white"></p>
                    <p id="player-ayah-number" class="text-xs text-gray-500 dark:text-gray-400"></p>
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mt-2">
                        <div id="player-progress" class="bg-emerald-500 h-1.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <button id="player-close" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <audio id="audio-player"></audio>

        <footer class="max-w-7xl mx-auto mt-12 py-6 px-4 text-center text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700">
            <p>&copy; <span id="current-year"></span> QuranTalks. Developed by MustafaTalks.</p>
        </footer>
    </div>

    <!-- Templates -->
    <template id="surah-card-template">
        <div class="surah-card p-5 bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl dark:hover:bg-gray-700 cursor-pointer transition-all duration-300 flex items-center space-x-4 rtl transform hover:-translate-y-1">
            <div class="surah-number flex-shrink-0 w-12 h-12 bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-300 rounded-lg flex items-center justify-center font-bold text-lg"></div>
            <div class="flex-grow">
                <div class="flex justify-between items-center">
                    <h3 class="surah-english-name text-lg font-semibold text-gray-800 dark:text-white"></h3>
                    <p class="surah-arabic-name text-xl font-amiri text-gray-700 dark:text-gray-300"></p>
                </div>
                <p class="surah-translation text-sm text-gray-500 dark:text-gray-400"></p>
            </div>
            <div class="text-right">
                <p class="surah-ayahs text-xs text-gray-400 dark:text-gray-500"></p>
                <p class="surah-revelation text-xs text-gray-400 dark:text-gray-500 capitalize"></p>
            </div>
        </div>
    </template>

    <template id="ayah-view-template">
        <div class="ayah-view p-4 rounded-lg shadow-sm transition-all duration-500 bg-white dark:bg-gray-800/50 border-l-4 border-transparent">
            <div class="flex justify-between items-center mb-4">
                <span class="ayah-number-badge text-sm font-semibold text-emerald-600 dark:text-emerald-400 bg-emerald-100 dark:bg-emerald-900 px-3 py-1 rounded-full"></span>
                <div class="flex items-center space-x-2">
                    <button class="bookmark-btn p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>
                    </button>
                    <button class="play-ayah-btn p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <svg class="play-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <svg class="pause-icon hidden h-5 w-5 text-emerald-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                    </button>
                </div>
            </div>
            <p dir="rtl" class="ayah-text text-2xl md:text-3xl font-amiri leading-loose text-right mb-4 text-gray-900 dark:text-white"></p>
            <p dir="rtl" class="ayah-translation-ur text-gray-600 dark:text-gray-300 leading-relaxed mt-2 font-urdu text-lg"></p>
        </div>
    </template>
    
    <script type="module">
        const QARIS = {
            'ar.alafasy': { name: 'Mishary Alafasy' },
            'ar.abdulbasitmurattal': { name: 'Abdul Basit' },
            'ar.abdulsamad': { name: 'Abdul Samad' },
            'ar.abdurrahmaansudais': { name: 'Abdur-Rahman as-Sudais' },
            'ar.saoodshuraym': { name: 'Saood bin Ibrahim Ash-Shuraim' },
            'ar.ahmedajamy': { name: 'Ahmed al-Ajamy' },
            'ar.husary': { name: 'Mahmud Al-Husary' },
            'ar.mahermuaiqly': { name: 'Maher Al Muaqily' },
            'ar.minshawi': { name: 'Mohamed Siddiq El-Minshawi' },
            'ar.muhammadjibreel': { name: 'Muhammad Jibreel' },
            'ar.saadalgamdi': { name: 'Saad Al Ghamdi' },
        };
        
        let state = {
            theme: localStorage.getItem('theme') || 'light',
            currentView: 'home',
            surahs: [],
            dailyAyah: null,
            selectedSurahNumber: null,
            selectedParaNumber: null,
            paraDetails: null,
            surahDetails: null,
            currentAyah: null,
            isPlaying: false,
            isAutoplaying: false,
            bookmarks: [],
            selectedQari: localStorage.getItem('selectedQari') || 'ar.alafasy',
            bismillah: null,
        };

        const DOMElements = {
            html: document.documentElement,
            app: document.getElementById('app'),
            views: document.querySelectorAll('.view'),
            navItems: document.querySelectorAll('[data-nav]'),
            themeToggle: document.getElementById('theme-toggle'),
            themeIconLight: document.getElementById('theme-icon-light'),
            themeIconDark: document.getElementById('theme-icon-dark'),
            surahList: document.getElementById('surah-list'),
            searchInput: document.getElementById('search-input'),
            audioPlayer: document.getElementById('audio-player'),
            floatingPlayer: document.getElementById('floating-player'),
            playerPlayPause: document.getElementById('player-play-pause'),
            playerClose: document.getElementById('player-close'),
            playerSurahName: document.getElementById('player-surah-name'),
            playerAyahNumber: document.getElementById('player-ayah-number'),
            playerProgress: document.getElementById('player-progress'),
            dailyAyahContainer: document.getElementById('daily-ayah-container'),
            loadingSpinner: document.getElementById('loading-spinner'),
            errorDisplay: document.getElementById('error-display'),
            currentYear: document.getElementById('current-year'),
            loadingOverlay: document.getElementById('loading-overlay'),
        };

        const Templates = {
            surahCard: document.getElementById('surah-card-template'),
            ayahView: document.getElementById('ayah-view-template'),
        };

        const fetchWithCache = async (url, cacheKey, expiryMinutes = 1440) => {
            const cachedItem = localStorage.getItem(cacheKey);
            if (cachedItem) {
                const { timestamp, data } = JSON.parse(cachedItem);
                const isExpired = (Date.now() - timestamp) > expiryMinutes * 60 * 1000;
                if (!isExpired) {
                    return data;
                }
            }
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                localStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), data }));
                return data;
            } catch (error) {
                console.error(`Failed to fetch ${url}:`, error);
                showError("Could not load data. Please check your internet connection.");
                return null;
            }
        };
        
        const safePlayAudio = (url) => {
            if (url && typeof url === 'string') {
                DOMElements.audioPlayer.src = url;
                const playPromise = DOMElements.audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        if (error.name !== 'AbortError') {
                            console.error('Audio playback error:', error);
                        }
                    });
                }
            } else {
                console.error('Invalid audio source provided:', url);
            }
        };

        const updateView = () => {
            DOMElements.views.forEach(view => view.classList.add('hidden'));
            const activeView = document.getElementById(`view-${state.currentView}`);
            if(activeView) activeView.classList.remove('hidden');

            DOMElements.navItems.forEach(item => {
                const nav = item.dataset.nav;
                item.classList.toggle('text-emerald-600', nav === state.currentView);
                item.classList.toggle('dark:text-emerald-400', nav === state.currentView);
                item.classList.toggle('text-gray-500', nav !== state.currentView);
                item.classList.toggle('dark:text-gray-400', nav !== state.currentView);
            });
            window.scrollTo(0, 0);
        };

        const renderSurahList = (surahsToRender) => {
            DOMElements.surahList.innerHTML = '';
            if (surahsToRender.length === 0) {
                DOMElements.surahList.innerHTML = `<p class="col-span-full text-center text-gray-500">No Surahs found.</p>`;
                return;
            }
            surahsToRender.forEach(surah => {
                const card = Templates.surahCard.content.cloneNode(true);
                card.querySelector('.surah-card').dataset.surahNumber = surah.number;
                card.querySelector('.surah-number').textContent = surah.number;
                card.querySelector('.surah-english-name').textContent = surah.englishName;
                card.querySelector('.surah-arabic-name').textContent = surah.name;
                card.querySelector('.surah-translation').textContent = surah.englishNameTranslation;
                card.querySelector('.surah-ayahs').textContent = `${surah.numberOfAyahs} Ayahs`;
                card.querySelector('.surah-revelation').textContent = surah.revelationType;
                DOMElements.surahList.appendChild(card);
            });
        };

        const renderSurahDetail = () => {
            const surah = state.surahs.find(s => s.number === state.selectedSurahNumber);
            const isSurahBookmarked = state.bookmarks.some(b => b.id === `S:${surah.number}`);
            
            const container = document.getElementById('view-surah');
            container.innerHTML = `
                <div id="surah-header" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 md:p-6 mb-6 sticky top-[65px] z-30">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex items-center space-x-2">
                            <button data-nav="home" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </button>
                            <div class="flex items-center gap-3">
                                <div>
                                    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">${surah.englishName} - <span class="font-amiri text-3xl">${surah.name}</span></h2>
                                    <p class="text-gray-500 dark:text-gray-400">${surah.englishNameTranslation}</p>
                                </div>
                                <button id="bookmark-surah-btn" class="p-2 rounded-full text-gray-500 hover:text-yellow-500 dark:hover:text-yellow-400 transition-colors ${isSurahBookmarked ? 'text-yellow-500' : ''}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${isSurahBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 w-full md:w-auto flex-wrap justify-end">
                            <div class="flex-grow md:flex-grow-0">
                                <label for="qari-select" class="text-xs font-medium text-gray-700 dark:text-gray-300">Reciter</label>
                                <select id="qari-select" class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm">
                                    ${Object.entries(QARIS).map(([id, qari]) => `<option value="${id}" ${id === state.selectedQari ? 'selected' : ''}>${qari.name}</option>`).join('')}
                                </select>
                            </div>
                            <button id="toggle-autoplay-btn" class="self-end px-4 py-2 rounded-md flex items-center gap-2 font-semibold transition-colors text-white ${state.isAutoplaying ? 'bg-red-500 hover:bg-red-600' : 'bg-emerald-500 hover:bg-emerald-600'}">
                                ${state.isAutoplaying ? '<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg><span>Pause</span>' : '<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>Play All</span>'}
                            </button>
                        </div>
                    </div>
                </div>
                <div id="surah-content" class="space-y-6"></div>
            `;
            const surahContent = container.querySelector('#surah-content');
            if (surah.number !== 1 && surah.number !== 9 && state.bismillah) {
                const bismillahView = createAyahView(state.bismillah, surah.number, false);
                surahContent.appendChild(bismillahView);
            }
            state.surahDetails.ayahs.forEach(ayah => {
                const ayahView = createAyahView(ayah, surah.number, true);
                surahContent.appendChild(ayahView);
            });
        };
        
        const createAyahView = (ayah, surahNumber, canBookmark) => {
            const card = Templates.ayahView.content.cloneNode(true);
            const ayahView = card.querySelector('.ayah-view');
            ayahView.dataset.ayahNumber = ayah.numberInSurah;
            ayahView.dataset.ayahNumberInQuran = ayah.number; // Unique identifier
            card.querySelector('.ayah-number-badge').textContent = ayah.numberInSurah === 0 ? 'Bismillah' : `${surahNumber}:${ayah.numberInSurah}`;
            
            const ayahTextContainer = card.querySelector('.ayah-text');
            ayahTextContainer.innerHTML = ''; // Clear previous content
            ayah.text.split(' ').forEach(word => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'ayah-word';
                wordSpan.textContent = word + ' ';
                ayahTextContainer.appendChild(wordSpan);
            });

            card.querySelector('.ayah-translation-ur').textContent = ayah.translation_ur;

            const bookmarkBtn = card.querySelector('.bookmark-btn');
            if (canBookmark) {
                const bookmarkId = `A:${surahNumber}:${ayah.numberInSurah}`;
                if (state.bookmarks.some(b => b.id === bookmarkId)) {
                    bookmarkBtn.classList.add('text-yellow-500');
                    bookmarkBtn.querySelector('svg').style.fill = 'currentColor';
                }
                bookmarkBtn.dataset.surahNumber = surahNumber;
                bookmarkBtn.dataset.ayahNumber = ayah.numberInSurah;
            } else {
                bookmarkBtn.style.display = 'none';
            }
            card.querySelector('.play-ayah-btn').dataset.ayahNumber = ayah.numberInSurah;
            card.querySelector('.play-ayah-btn').dataset.surahNumber = surahNumber;
            return card;
        };

        const renderDailyAyah = () => {
            if (!state.dailyAyah) return;
            const { text, urdu_translation, surah, numberInSurah } = state.dailyAyah;
            DOMElements.dailyAyahContainer.innerHTML = `
                <div class="bg-gradient-to-br from-emerald-50 to-teal-100 dark:from-emerald-900/50 dark:to-teal-900/50 p-6 rounded-xl shadow-lg border border-emerald-200 dark:border-emerald-800">
                    <h3 class="font-bold text-lg text-emerald-800 dark:text-emerald-200 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2 text-yellow-400"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                        Ayah of the Day
                    </h3>
                    <p dir="rtl" class="text-xl font-amiri text-right mb-3 text-gray-800 dark:text-gray-100">${text}</p>
                    <p dir="rtl" class="text-gray-600 font-urdu text-lg dark:text-gray-300 mb-3">${urdu_translation}</p>
                    <p class="text-sm text-right font-semibold text-emerald-700 dark:text-emerald-400">Surah ${surah.englishName} (${surah.number}:${numberInSurah})</p>
                </div>
            `;
        };
        
        const renderBookmarks = () => {
            const container = document.getElementById('view-bookmarks');
            let content;
            if (state.bookmarks.length === 0) {
                content = `
                    <div class="text-center py-10 px-6 bg-white dark:bg-gray-800 rounded-lg shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>
                        <h3 class="mt-4 text-xl font-semibold text-gray-800 dark:text-white">No Bookmarks Yet</h3>
                        <p class="mt-2 text-gray-500 dark:text-gray-400">You can bookmark a Surah or an Ayah from the Surah reading page.</p>
                    </div>
                `;
            } else {
                content = state.bookmarks.sort((a,b) => a.id.localeCompare(b.id)).map(b => {
                    const isSurahBookmark = b.id.startsWith('S:');
                    return `
                    <div class="bookmark-item bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm hover:shadow-lg cursor-pointer transition-shadow flex items-center justify-between" data-bookmark-id="${b.id}">
                        <div>
                            <p class="font-semibold text-emerald-600 dark:text-emerald-400">${isSurahBookmark ? `Surah ${b.surahName}` : `Surah ${b.surahName}, Ayah ${b.ayahNumber}`}</p>
                            ${!isSurahBookmark ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate font-urdu rtl">${b.text}</p>` : ''}
                        </div>
                        <button class="remove-bookmark-btn p-2 text-gray-400 hover:text-red-500 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                `}).join('');
            }
            container.innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="flex items-center space-x-4 mb-6">
                         <button data-nav="home" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h2 class="text-3xl font-bold">My Bookmarks</h2>
                    </div>
                    <div class="space-y-4">${content}</div>
                </div>
            `;
        };
        
        const renderAbout = () => {
            document.getElementById('view-about').innerHTML = `
                <div class="max-w-2xl mx-auto bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-lg">
                     <div class="flex items-center space-x-4 mb-6">
                         <button data-nav="home" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h2 class="text-3xl font-bold">About QuranTalks</h2>
                    </div>
                    <div class="space-y-6 text-gray-600 dark:text-gray-300">
                        <p><strong>QuranTalks</strong> is a modern, responsive, and elegant web application designed to help you read, listen to, and reflect upon the Holy Quran.</p>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 dark:text-white mb-2">Developer Credits</h3>
                            <p>This application was developed with care by <strong>MustafaTalks</strong>, leveraging modern web technologies to provide a seamless and accessible experience for all users.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 dark:text-white mb-2">Data Source & Technology</h3>
                            <p>All Quranic text, translations, and audio are sourced from the reliable <a href="https://alquran.cloud/api" target="_blank" rel="noopener noreferrer" class="text-emerald-500 hover:underline">Al Quran Cloud API</a>. The interface is built with HTML, Tailwind CSS for styling, and vanilla JavaScript for interactivity.</p>
                        </div>
                        <p class="text-center text-sm text-gray-500 dark:text-gray-400">Version 2.5.0</p>
                    </div>
                </div>
            `;
        };
        
        const learnLessons = [
            {
                title: "Lesson 1: The Alphabet (حروف مفردات)",
                items: [ 'ا', 'ب', 'ت', 'ث', 'ج', 'ح', 'خ', 'د', 'ذ', 'ر', 'ز', 'س', 'ش', 'ص', 'ض', 'ط', 'ظ', 'ع', 'غ', 'ف', 'ق', 'ك', 'ل', 'م', 'ن', 'ه', 'و', 'ي' ],
                type: 'grid'
            },
            {
                title: "Lesson 2: Joined Letters (مرکبات)",
                items: [ 'ـبـ', 'ـتـ', 'ـثـ', 'ـجـ', 'ـحـ', 'ـخـ', 'ـنـ', 'ـيـ', 'بـ', 'تـ', 'ثـ', 'نـ', 'يـ' ],
                type: 'grid'
            },
            {
                title: "Lesson 3: Vowels (حرکات)",
                description: "Fatha (zabar), Kasra (zer), and Damma (pesh).",
                items: [ 'بَ', 'بِ', 'بُ', 'تَ', 'تِ', 'تُ', 'ثَ', 'ثِ', 'ثُ', 'جَ', 'جِ', 'جُ' ],
                type: 'grid'
            }
        ];
        
        const renderLearnQuran = () => {
            const lesson = learnLessons[state.currentLearnLesson];
            let content = lesson.items.map(item => `
                <div class="learn-item-card bg-emerald-100 dark:bg-emerald-800/50 rounded-lg shadow-lg flex flex-col items-center justify-center p-4 cursor-pointer hover:bg-emerald-200 dark:hover:bg-emerald-700 transition-all aspect-square">
                    <p class="text-6xl font-amiri text-emerald-700 dark:text-emerald-300">${item}</p>
                </div>
            `).join('');

            document.getElementById('view-learn').innerHTML = `
                 <div class="max-w-4xl mx-auto">
                    <div class="flex items-center space-x-4 mb-6">
                         <button data-nav="home" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h2 class="text-3xl font-bold">Learn Quran</h2>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg mb-6">
                        <h3 class="text-2xl font-bold text-center mb-2">${lesson.title}</h3>
                        ${lesson.description ? `<p class="text-center text-gray-500 dark:text-gray-400">${lesson.description}</p>` : ''}
                    </div>
                    <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-7 gap-4">${content}</div>
                    <div class="flex justify-between mt-8">
                        <button id="prev-lesson-btn" class="px-4 py-2 rounded-md bg-gray-300 dark:bg-gray-700 ${state.currentLearnLesson === 0 ? 'opacity-50 cursor-not-allowed' : ''}">Previous</button>
                        <button id="next-lesson-btn" class="px-4 py-2 rounded-md bg-emerald-500 text-white ${state.currentLearnLesson === learnLessons.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}">Next</button>
                    </div>
                </div>
            `;
        };
        
        const renderParas = () => {
            let content = Array.from({ length: 30 }, (_, i) => {
                const paraNumber = i + 1;
                return `
                    <div class="para-card bg-white dark:bg-gray-800 p-5 rounded-lg shadow-md hover:shadow-xl dark:hover:bg-gray-700 cursor-pointer transition-all duration-300 flex items-center space-x-4 transform hover:-translate-y-1" data-para-number="${paraNumber}">
                         <div class="flex-shrink-0 w-12 h-12 bg-emerald-100 dark:bg-emerald-900 text-emerald-600 dark:text-emerald-300 rounded-lg flex items-center justify-center font-bold text-lg">${paraNumber}</div>
                         <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Para ${paraNumber}</h3>
                         </div>
                    </div>
                `;
            }).join('');

            document.getElementById('view-paras').innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center space-x-4 mb-6">
                         <button data-nav="home" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h2 class="text-3xl font-bold">All Paras (Juz)</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${content}</div>
                </div>
            `;
        };

        const playAyah = (ayah, isAuto = false) => {
            if (!isAuto) {
                state.isAutoplaying = false;
                updateAutoplayButton();
            }
            const surahName = ayah.surah ? ayah.surah.englishName : state.surahs.find(s => s.number === state.selectedSurahNumber).englishName;
            state.currentAyah = { ...ayah, surahName: surahName, surahNumber: ayah.surah ? ayah.surah.number : state.selectedSurahNumber };
            safePlayAudio(ayah.audio);
            updateFloatingPlayer();
        };

        const updateAutoplayButton = () => {
            const btn = document.getElementById('toggle-autoplay-btn');
            if(!btn) return;
            btn.innerHTML = state.isAutoplaying ? '<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg><span>Pause</span>' : '<svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span>Play All</span>';
            btn.classList.toggle('bg-red-500', state.isAutoplaying);
            btn.classList.toggle('hover:bg-red-600', state.isAutoplaying);
            btn.classList.toggle('bg-emerald-500', !state.isAutoplaying);
            btn.classList.toggle('hover:bg-emerald-600', !state.isAutoplaying);
        };
        
        const toggleAutoplay = () => {
            state.isAutoplaying = !state.isAutoplaying;
            updateAutoplayButton();
            if (state.isAutoplaying) {
                const firstAyahToPlay = (state.selectedSurahNumber !== 1 && state.selectedSurahNumber !== 9) 
                    ? state.bismillah
                    : state.surahDetails.ayahs[0];
                playAyah(firstAyahToPlay, true);
            } else {
                DOMElements.audioPlayer.pause();
            }
        };

        const updateFloatingPlayer = () => {
            if (state.currentAyah) {
                DOMElements.floatingPlayer.classList.remove('hidden');
                DOMElements.playerSurahName.textContent = `Playing Surah ${state.currentAyah.surahName}`;
                DOMElements.playerAyahNumber.textContent = state.currentAyah.numberInSurah === 0 ? 'Bismillah' : `Ayah ${state.currentAyah.numberInSurah}`;
            } else {
                DOMElements.floatingPlayer.classList.add('hidden');
            }
            updatePlayerPlayPauseIcon();
        };
        
        const updatePlayerPlayPauseIcon = () => {
            const icon = state.isPlaying 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
            DOMElements.playerPlayPause.innerHTML = icon;
        };
        
        const updateActiveAyahHighlight = () => {
            document.querySelectorAll('.ayah-view').forEach(el => el.classList.remove('active'));
            if (state.isPlaying && state.currentAyah && (state.currentView === 'surah' || state.currentView === 'para-reader')) {
                const activeAyahEl = document.querySelector(`.ayah-view[data-ayah-number-in-quran="${state.currentAyah.number}"]`);
                if (activeAyahEl) {
                    activeAyahEl.classList.add('active');
                    activeAyahEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.querySelectorAll('.play-ayah-btn .pause-icon').forEach(i => i.classList.add('hidden'));
                    document.querySelectorAll('.play-ayah-btn .play-icon').forEach(i => i.classList.remove('hidden'));
                    const activeBtn = activeAyahEl.querySelector('.play-ayah-btn');
                    activeBtn.querySelector('.play-icon').classList.add('hidden');
                    activeBtn.querySelector('.pause-icon').classList.remove('hidden');
                }
            } else {
                 document.querySelectorAll('.play-ayah-btn .pause-icon').forEach(i => i.classList.add('hidden'));
                 document.querySelectorAll('.play-ayah-btn .play-icon').forEach(i => i.classList.remove('hidden'));
            }
        };

        const handleNavClick = (e) => {
            const navTarget = e.target.closest('[data-nav]');
            if (navTarget) {
                state.currentView = navTarget.dataset.nav;
                if (state.currentView === 'bookmarks') renderBookmarks();
                else if (state.currentView === 'about') renderAbout();
                else if (state.currentView === 'learn') renderLearnQuran();
                else if (state.currentView === 'paras') renderParas();
                updateView();
            }
        };

        const handleSurahClick = async (surahNumber) => {
            state.selectedSurahNumber = surahNumber;
            state.currentView = 'surah';
            showLoading();
            updateView();
            const editions = `${state.selectedQari},ur.jalandhry`;
            const url = `https://api.alquran.cloud/v1/surah/${state.selectedSurahNumber}/editions/${editions}`;
            const data = await fetchWithCache(url, `surah_ur_${state.selectedSurahNumber}_${state.selectedQari}`);
            if (data && data.data) {
                const [qariData, urData] = data.data;
                const combinedAyahs = qariData.ayahs.map((ayah, index) => ({
                    ...ayah,
                    translation_ur: urData.ayahs[index].text,
                }));
                state.surahDetails = { ...qariData, ayahs: combinedAyahs };
                renderSurahDetail();
            }
            hideLoading();
        };
        
        const handleParaClick = async (paraNumber) => {
            state.selectedParaNumber = paraNumber;
            state.currentView = 'para-reader';
            showLoading();
            updateView();
            const qariUrl = `https://api.alquran.cloud/v1/juz/${paraNumber}/${state.selectedQari}`;
            const urduUrl = `https://api.alquran.cloud/v1/juz/${paraNumber}/ur.jalandhry`;

            const [qariResponse, urduResponse] = await Promise.all([
                fetchWithCache(qariUrl, `para_qari_${paraNumber}_${state.selectedQari}`),
                fetchWithCache(urduUrl, `para_urdu_${paraNumber}`)
            ]);
            
            if (qariResponse && qariResponse.data && urduResponse && urduResponse.data) {
                const qariData = qariResponse.data;
                const urduData = urduResponse.data;

                const combinedAyahs = qariData.ayahs.map((ayah, index) => ({
                    ...ayah,
                    translation_ur: urduData.ayahs[index] ? urduData.ayahs[index].text : '',
                }));
                state.paraDetails = { ...qariData, number: paraNumber, ayahs: combinedAyahs };
                renderParaDetail();
            }
            hideLoading();
        };

        const renderParaDetail = () => {
            const para = state.paraDetails;
            const container = document.getElementById('view-para-reader');

            container.innerHTML = `
                <div id="para-reader-header" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 md:p-6 mb-6 sticky top-[65px] z-30">
                    <div class="flex items-center space-x-2">
                        <button data-nav="paras" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Para ${para.number}</h2>
                        </div>
                    </div>
                </div>
                <div id="para-content" class="space-y-6"></div>
            `;

            const paraContent = container.querySelector('#para-content');
            let lastSurahNumber = -1;

            para.ayahs.forEach(ayah => {
                if (ayah.surah.number !== lastSurahNumber) {
                    lastSurahNumber = ayah.surah.number;
                    const surahHeader = document.createElement('div');
                    surahHeader.className = 'text-center my-8 p-4 bg-emerald-100 dark:bg-emerald-900 rounded-lg';
                    surahHeader.innerHTML = `
                        <h3 class="text-2xl font-amiri text-emerald-700 dark:text-emerald-300">${ayah.surah.name}</h3>
                        <p class="text-lg font-semibold text-emerald-600 dark:text-emerald-400">${ayah.surah.englishName}</p>
                    `;
                    paraContent.appendChild(surahHeader);

                    if (ayah.surah.number !== 1 && ayah.surah.number !== 9 && state.bismillah) {
                         const bismillahView = createAyahView(state.bismillah, ayah.surah.number, false);
                         paraContent.appendChild(bismillahView);
                    }
                }

                const ayahView = createAyahView(ayah, ayah.surah.number, true);
                paraContent.appendChild(ayahView);
            });
        };

        const handleContentClick = (e) => {
            const surahCard = e.target.closest('.surah-card');
            if (surahCard) handleSurahClick(parseInt(surahCard.dataset.surahNumber));

            const paraCard = e.target.closest('.para-card');
            if(paraCard) handleParaClick(parseInt(paraCard.dataset.paraNumber));

            const bookmarkItem = e.target.closest('.bookmark-item');
            if (bookmarkItem) {
                const id = bookmarkItem.dataset.bookmarkId;
                if (id.startsWith('S:') || id.startsWith('A:')) {
                    handleSurahClick(parseInt(id.split(':')[1]));
                }
            }
            
            const removeBookmarkBtn = e.target.closest('.remove-bookmark-btn');
            if(removeBookmarkBtn) {
                const id = removeBookmarkBtn.closest('.bookmark-item').dataset.bookmarkId;
                state.bookmarks = state.bookmarks.filter(b => b.id !== id);
                localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
                renderBookmarks();
                return;
            }

            const playBtn = e.target.closest('.play-ayah-btn');
            if (playBtn) {
                const surahNumber = parseInt(playBtn.dataset.surahNumber);
                const ayahNumber = parseInt(playBtn.dataset.ayahNumber);
                const isBismillah = ayahNumber === 0;
                let ayahData;

                if (isBismillah) {
                    ayahData = state.bismillah;
                } else if (state.currentView === 'surah') {
                    ayahData = state.surahDetails.ayahs.find(a => a.numberInSurah === ayahNumber);
                } else if (state.currentView === 'para-reader') {
                    ayahData = state.paraDetails.ayahs.find(a => a.numberInSurah === ayahNumber && a.surah.number === surahNumber);
                }
                
                if (ayahData) playAyah(ayahData);
            }
            
            const bookmarkBtn = e.target.closest('.bookmark-btn');
            if (bookmarkBtn) {
                const surahNumber = parseInt(bookmarkBtn.dataset.surahNumber);
                const ayahNumber = parseInt(bookmarkBtn.dataset.ayahNumber);
                toggleBookmark(`A:${surahNumber}:${ayahNumber}`);
                bookmarkBtn.classList.toggle('text-yellow-500');
                bookmarkBtn.querySelector('svg').style.fill = bookmarkBtn.classList.contains('text-yellow-500') ? 'currentColor' : 'none';
            }

            if (e.target.closest('#toggle-autoplay-btn')) toggleAutoplay();
            
            if (e.target.closest('#bookmark-surah-btn')) {
                 toggleBookmark(`S:${state.selectedSurahNumber}`);
                 const btn = e.target.closest('#bookmark-surah-btn');
                 const isBookmarked = state.bookmarks.some(b => b.id === `S:${state.selectedSurahNumber}`);
                 btn.classList.toggle('text-yellow-500', isBookmarked);
                 btn.querySelector('svg').setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
            }
            
            const learnItemCard = e.target.closest('.learn-item-card');
            if(learnItemCard && state.bismillah) {
                safePlayAudio(state.bismillah.audio);
            }

            if (e.target.id === 'next-lesson-btn' && state.currentLearnLesson < learnLessons.length - 1) {
                state.currentLearnLesson++;
                renderLearnQuran();
            }
            if (e.target.id === 'prev-lesson-btn' && state.currentLearnLesson > 0) {
                state.currentLearnLesson--;
                renderLearnQuran();
            }
        };

        const handleHeaderChange = (e) => {
            if (e.target.id === 'qari-select') {
                state.selectedQari = e.target.value;
                localStorage.setItem('selectedQari', state.selectedQari);
                if(state.currentView === 'surah') {
                    handleSurahClick(state.selectedSurahNumber);
                } else if(state.currentView === 'para-reader') {
                    handleParaClick(state.selectedParaNumber);
                }
            }
        };

        const toggleBookmark = (bookmarkId) => {
            const index = state.bookmarks.findIndex(b => b.id === bookmarkId);
            if (index > -1) {
                state.bookmarks.splice(index, 1);
            } else {
                if (bookmarkId.startsWith('S:')) {
                    const surahNumber = parseInt(bookmarkId.split(':')[1]);
                    const surah = state.surahs.find(s => s.number === surahNumber);
                    state.bookmarks.push({ id: bookmarkId, surahNumber, surahName: surah.englishName });
                } else {
                    const [, surahNumberStr, ayahNumberStr] = bookmarkId.split(':');
                    const surahNumber = parseInt(surahNumberStr);
                    const ayahNumber = parseInt(ayahNumberStr);
                    const surah = state.surahs.find(s => s.number === surahNumber);
                    const ayah = (state.surahDetails || state.paraDetails).ayahs.find(a => a.numberInSurah === ayahNumber && a.surah.number === surahNumber);
                    state.bookmarks.push({ id: bookmarkId, surahNumber, ayahNumber, surahName: surah.englishName, text: ayah.translation_ur.substring(0, 70) + '...' });
                }
            }
            localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
        };

        const applyTheme = () => {
            DOMElements.html.classList.toggle('dark', state.theme === 'dark');
            DOMElements.themeIconDark.classList.toggle('hidden', state.theme !== 'dark');
            DOMElements.themeIconLight.classList.toggle('hidden', state.theme === 'dark');
        };

        const showLoading = () => {
            DOMElements.views.forEach(v => v.classList.add('hidden'));
            DOMElements.loadingSpinner.classList.remove('hidden');
            DOMElements.loadingSpinner.classList.add('flex');
        };
        const hideLoading = () => {
            DOMElements.loadingSpinner.classList.add('hidden');
            DOMElements.loadingSpinner.classList.remove('flex');
        };
        const showError = (message) => {
            DOMElements.errorDisplay.innerHTML = `<div class="text-center py-20 px-6 bg-red-50 dark:bg-red-900/20 rounded-lg shadow-md max-w-2xl mx-auto"><h3 class="mt-4 text-xl font-semibold text-red-800 dark:text-red-200">An Error Occurred</h3><p class="mt-2 text-red-600 dark:text-red-300">${message}</p></div>`;
            DOMElements.errorDisplay.classList.remove('hidden');
            hideLoading();
        };
        
        const init = async () => {
            DOMElements.app.addEventListener('click', handleNavClick);
            DOMElements.app.addEventListener('click', handleContentClick);
            DOMElements.app.addEventListener('change', handleHeaderChange);
            DOMElements.themeToggle.addEventListener('click', () => {
                state.theme = state.theme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', state.theme);
                applyTheme();
            });
            DOMElements.searchInput.addEventListener('input', e => renderSurahList(state.surahs.filter(s => s.englishName.toLowerCase().includes(e.target.value.toLowerCase()) || s.name.includes(e.target.value) || String(s.number).includes(e.target.value))));
            DOMElements.audioPlayer.addEventListener('play', () => { state.isPlaying = true; updatePlayerPlayPauseIcon(); updateActiveAyahHighlight(); });
            DOMElements.audioPlayer.addEventListener('pause', () => { state.isPlaying = false; updatePlayerPlayPauseIcon(); updateActiveAyahHighlight(); });
            DOMElements.audioPlayer.addEventListener('ended', () => {
                if(state.isAutoplaying) {
                    const currentIdx = state.currentAyah.numberInSurah === 0 ? -1 : state.surahDetails.ayahs.findIndex(a => a.numberInSurah === state.currentAyah.numberInSurah);
                    if (currentIdx < state.surahDetails.ayahs.length - 1) {
                        playAyah(state.surahDetails.ayahs[currentIdx + 1], true);
                    } else {
                        state.isAutoplaying = false;
                        updateAutoplayButton();
                    }
                }
            });
            DOMElements.audioPlayer.addEventListener('timeupdate', () => {
                if (DOMElements.audioPlayer.duration) {
                    DOMElements.playerProgress.style.width = `${(DOMElements.audioPlayer.currentTime / DOMElements.audioPlayer.duration) * 100}%`;
                }
            });
            DOMElements.playerPlayPause.addEventListener('click', () => {
                if (DOMElements.audioPlayer.paused) {
                    safePlayAudio(DOMElements.audioPlayer.src);
                } else {
                    DOMElements.audioPlayer.pause();
                }
            });
            DOMElements.playerClose.addEventListener('click', () => {
                DOMElements.audioPlayer.pause();
                state.currentAyah = null;
                state.isAutoplaying = false;
                updateFloatingPlayer();
            });

            DOMElements.currentYear.textContent = new Date().getFullYear();
            state.bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
            applyTheme();
            
            const minDelayPromise = new Promise(resolve => setTimeout(resolve, 1000));

            const fetchDataPromise = (async () => {
                const [surahsData, dailyAyahData, bismillahData] = await Promise.all([
                    fetchWithCache('https://api.alquran.cloud/v1/surah', 'allSurahs'),
                    fetchWithCache('https://api.alquran.cloud/v1/ayah/random/editions/quran-uthmani,ur.jalandhry', 'dailyAyah', 24 * 60),
                    fetchWithCache(`https://api.alquran.cloud/v1/ayah/1/editions/ar.alafasy,ur.jalandhry`, 'bismillahData')
                ]);
                
                if (surahsData && surahsData.data) {
                    state.surahs = surahsData.data;
                }
                if (dailyAyahData && dailyAyahData.data) {
                    const [arData, urData] = dailyAyahData.data;
                    state.dailyAyah = { 
                        ...arData, 
                        urdu_translation: urData.text,
                    };
                }
                if(bismillahData && bismillahData.data) {
                    state.bismillah = {
                        numberInSurah: 0,
                        text: bismillahData.data[0].text,
                        audio: bismillahData.data[0].audio,
                        translation_ur: bismillahData.data[1].text,
                    };
                }
            })();
            
            await Promise.all([minDelayPromise, fetchDataPromise]);

            renderSurahList(state.surahs);
            renderDailyAyah();
            updateView();

            DOMElements.loadingOverlay.style.opacity = '0';
            DOMElements.app.style.opacity = '1';
            setTimeout(() => DOMElements.loadingOverlay.style.display = 'none', 500);
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
